WPForms.Admin.Builder.Providers.Drip=WPForms.Admin.Builder.Providers.Drip||function(s){"use strict";var p={config:{templates:["wpforms-drip-builder-content-connection","wpforms-drip-builder-content-connection-events","wpforms-drip-builder-content-connection-subscriber-delete","wpforms-drip-builder-content-connection-subscriber-subscribe","wpforms-drip-builder-content-connection-campaigns-add","wpforms-drip-builder-content-connection-campaigns-delete"]},replaceConnectionIds:function(e,n){e.parents(".wpforms-builder-provider-connection").find("input, textarea, select, label").each(function(){s(this).attr("name")&&s(this).attr("name",s(this).attr("name").replace(/%connection_id%/gi,n)),s(this).attr("id")&&s(this).attr("id",s(this).attr("id").replace(/%connection_id%/gi,n)),s(this).attr("for")&&s(this).attr("for",s(this).attr("for").replace(/%connection_id%/gi,n)),s(this).attr("data-name")&&s(this).attr("data-name",s(this).attr("data-name").replace(/%connection_id%/gi,n))})},getConnectionById:function(e){return p.config.$holder.find('.wpforms-builder-provider-connection[data-connection_id="'+e+'"]')},connectionAccountExists:function(r,e){return!!_.isEmpty(r)||void 0!==_.find(e,function(e){var n,i,o=!1;for(n=0,i=e.length;n<i;n++)if(_.isMatch(e[n],{id:r})){o=!0;break}return o})}},l={provider:"drip",Providers:{},Cache:{},init:function(){l.Providers=WPForms.Admin.Builder.Providers,l.Templates=WPForms.Admin.Builder.Templates,l.Cache=l.Providers.cache,s("#wpforms-panel-providers").on("WPForms.Admin.Builder.Providers.ready",l.ready)},ready:function(){p.config.$holder=s("#drip-provider").find(".wpforms-builder-provider-body"),l.Templates.add(p.config.templates),l.Providers.ui.account.registerAddHandler(l.provider,l.processAccountAdd),l.processInitialTemplates(),l.bindUIActions(),l.bindTriggers()},processInitialTemplates:function(){l.Providers.ajax.request(l.provider,{data:{task:"connections_get"}}).done(function(e){if(e.success&&e.data.hasOwnProperty("connections")){l.Cache.set(l.provider,"connections",jQuery.extend({},e.data.connections)),l.Cache.set(l.provider,"conditionals",jQuery.extend({},e.data.conditionals)),_.isEmpty(e.data,"accounts")||l.Cache.set(l.provider,"accounts",jQuery.extend({},e.data.accounts));for(var n in e.data.connections)e.data.connections.hasOwnProperty(n)&&(l.connectionGenerate({connection:l.Cache.getById(l.provider,"connections",n),conditional:l.Cache.getById(l.provider,"conditionals",n)}),0)}})},processAccountAdd:function(n){var e=s.trim(n.$content.find('input[name="account_name"]').val()),i=s.trim(n.$content.find('input[name="api_token"]').val()),o=n.$content.find(".error");return _.isEmpty(i)?(o.show(),n.setType("red"),n.$content.find('input[name="api_token"]').addClass("wpforms-error")):(n.setType("blue"),o.hide(),l.Providers.ajax.request(l.provider,{data:{task:"account_save",acc_name:e,acc_token:i}}).done(function(e){e.success?_.isEmpty(e.data.error)?(l.Providers.getProviderHolder(l.provider).find(".wpforms-builder-provider-title-add").toggleClass("hidden"),n.close()):(n.setType("red"),o.html(e.data.error).show()):(n.setType("red"),o.show(),console.log(e))})),!1},bindUIActions:function(){var o=s("#drip-provider");o.on("connectionCreate",function(e,n){l.connectionCreate(n)}),s(".wpforms-builder-provider").on("connectionDelete",function(e,n){if(n.parents(o).length){var i=n.data("connection_id");void 0!==i&&l.Cache.deleteFrom(l.provider,"connections",i)}}),o.on("change",".js-wpforms-builder-drip-provider-connection-account",function(){var e=s(this).parents(".wpforms-builder-provider-connection"),n=l.connectionGetOptionId(e);if(""===s(this).val())return s(".wpforms-builder-drip-provider-actions-data",e).empty(),void s(".js-wpforms-builder-drip-provider-connection-action",e).attr("disabled",!0).val("");s(".js-wpforms-builder-drip-provider-connection-action",e).removeAttr("disabled"),e.find(".wpforms-builder-provider-connection-option_id").val(n),p.config.$holder.trigger("accountChanged",[n,e])}),o.on("change",".js-wpforms-builder-drip-provider-connection-action",function(){var r=s(this),t=s(this).parents(".wpforms-builder-provider-connection"),c=t.data("connection_id"),e=l.connectionGetOptionId(t),n=t.find(".wpforms-builder-drip-provider-accounts select").val(),i=s(this).val();switch(s(".wpforms-builder-drip-provider-actions-data",t).empty(),i){case"event":l.Providers.ajax.request(l.provider,{data:{connection_account_id:n,connection_option_id:e,connection_id:c,connection_action:i,task:"events_get"}}).done(function(e){if(e.data.hasOwnProperty("events")){l.Cache.set(l.provider,"events",e.data.events);var n=l.Templates.get("wpforms-drip-builder-content-connection-events"),i=l.Templates.get("wpforms-providers-builder-content-connection-fields");t.find(".wpforms-builder-drip-provider-actions-data").html(n({connection:l.Cache.getById(l.provider,"connections",c),events:l.Cache.getById(l.provider,"events",c)})+i({connection:l.Cache.getById(l.provider,"connections",c),fields:wpf.getFields(),provider:{slug:l.provider}})),p.replaceConnectionIds(r,c),l.mapEmailsField(c,t),s("#wpforms-panel-providers").trigger("connectionRendered",["drip",c])}});break;case"subscriber_delete":var o=l.Templates.get("wpforms-drip-builder-content-connection-subscriber-delete");t.find(".wpforms-builder-drip-provider-actions-data").html(o({connection:l.Cache.getById(l.provider,"connections",c)})),p.replaceConnectionIds(r,c),l.mapEmailsField(c,t),s("#wpforms-panel-providers").trigger("connectionRendered",["drip",c]);break;case"subscriber_subscribe":var d=l.Templates.get("wpforms-drip-builder-content-connection-subscriber-subscribe"),a=l.Templates.get("wpforms-providers-builder-content-connection-fields");t.find(".wpforms-builder-drip-provider-actions-data").html(d({connection:l.Cache.getById(l.provider,"connections",c)})+a({connection:l.Cache.getById(l.provider,"connections",c),fields:wpf.getFields(),provider:{slug:l.provider}})),p.replaceConnectionIds(r,c),l.mapEmailsField(c,t),s("#wpforms-panel-providers").trigger("connectionRendered",["drip",c]);break;case"campaign_sub":l.Providers.ajax.request(l.provider,{data:{connection_account_id:n,connection_option_id:e,connection_id:c,connection_action:i,task:"campaigns_get"}}).done(function(e){if(e.data.hasOwnProperty("campaigns")){l.Cache.set(l.provider,"campaigns",e.data.campaigns);var n=l.Templates.get("wpforms-drip-builder-content-connection-campaigns-add"),i=l.Templates.get("wpforms-drip-builder-content-connection-subscriber-subscribe"),o=l.Templates.get("wpforms-providers-builder-content-connection-fields");t.find(".wpforms-builder-drip-provider-actions-data").html(n({connection:l.Cache.getById(l.provider,"connections",c),campaigns:l.Cache.getById(l.provider,"campaigns",c)})+i({connection:l.Cache.getById(l.provider,"connections",c),ignore:["new_email","ip_address","tags_delete"]})+o({connection:l.Cache.getById(l.provider,"connections",c),fields:wpf.getFields(),provider:{slug:l.provider}})),p.replaceConnectionIds(r,c),l.mapEmailsField(c,t),s("#wpforms-panel-providers").trigger("connectionRendered",["drip",c])}});break;case"campaign_unsub":l.Providers.ajax.request(l.provider,{data:{connection_account_id:n,connection_option_id:e,connection_id:c,connection_action:i,task:"campaigns_get"}}).done(function(e){if(e.data.hasOwnProperty("campaigns")){l.Cache.set(l.provider,"campaigns",e.data.campaigns);var n=l.Templates.get("wpforms-drip-builder-content-connection-campaigns-delete");t.find(".wpforms-builder-drip-provider-actions-data").html(n({connection:l.Cache.getById(l.provider,"connections",c),campaigns:l.Cache.getById(l.provider,"campaigns",c)})),p.replaceConnectionIds(r,c),l.mapEmailsField(c,t),s("#wpforms-panel-providers").trigger("connectionRendered",["drip",c])}})}p.config.$holder.trigger("actionChanged",[c,t,i])}),o.on("click",".js-wpforms-builder-drip-provider-connection-event-new",function(e){e.preventDefault();var n=s(this).parents(".wpforms-builder-provider-connection");s(".js-wpforms-builder-drip-provider-connection-event",n).val(""),l.connectionEventNew(n)}),o.on("click",'.wpforms-builder-drip-provider-prospect-check input[type="checkbox"]',function(){s(this).parents(".wpforms-builder-drip-provider-prospect").find(".wpforms-builder-drip-provider-prospect-score").toggleClass("hidden")})},bindTriggers:function(){p.config.$holder.on("connectionGenerated",function(e,n){var i=p.getConnectionById(n.connection.id);s(".js-wpforms-builder-drip-provider-connection-account",i).trigger("change",[i]),s(".js-wpforms-builder-drip-provider-connection-action",i).trigger("change",[i])}),p.config.$holder.on("DOMNodeInsertedIntoDocument DOMNodeRemovedFromDocument",".wpforms-conditional-block-panel",function(){p.replaceConnectionIds(s(this),s(this).parents(".wpforms-builder-provider-connection").data("connection_id"))})},connectionCreate:function(e){var n=(new Date).getTime().toString(16),i={id:n,name:e,isNew:!0};l.Cache.addTo(l.provider,"connections",n,i),l.connectionGenerate({connection:i})},connectionGenerate:function(n){var i=l.Templates.get("wpforms-drip-builder-content-connection"),o=n.connection.hasOwnProperty("isNew")&&n.connection.isNew?l.Templates.get("wpforms-providers-builder-content-connection-conditionals")():n.conditional,e=l.Cache.get(l.provider,"accounts");_.isEmpty(e)?l.Providers.ajax.request(l.provider,{data:{task:"accounts_get"}}).done(function(e){e.data.hasOwnProperty("accounts")&&(l.Cache.set(l.provider,"accounts",e.data.accounts),p.connectionAccountExists(n.connection.account_id,e.data.accounts)&&(p.config.$holder.find(".wpforms-builder-provider-connections").prepend(i({connection:n.connection,accounts:e.data.accounts,conditional:o})),p.config.$holder.trigger("connectionGenerated",[n])))}):p.connectionAccountExists(n.connection.account_id,e)&&(p.config.$holder.find(".wpforms-builder-provider-connections").prepend(i({connection:n.connection,accounts:e,conditional:o})),p.config.$holder.trigger("connectionGenerated",[n]))},connectionEventNew:function(e){var n=e.find(".wpforms-builder-drip-provider-events-new");n.is(":visible")?n.hide(400,function(){n.find("input").val("")}):n.show("fast",function(){s(this).find("input").focus()})},mapEmailsField:function(e,n){var i=l.Cache.getById(l.provider,"connections",e);_.isEmpty(i)||_.isEmpty(i.fields)||_.isEmpty(i.fields.email)&&_.isEmpty(i.fields.new_email)||(s('select[name="providers[drip]['+e+'][fields][email]"]',n).val(i.fields.email),s('select[name="providers[drip]['+e+'][fields][new_email]"]',n).val(i.fields.new_email))},connectionGetOptionId:function(e){return e.find(".wpforms-builder-drip-provider-accounts select :selected").data("option_id")}};return l}((document,window,jQuery)),WPForms.Admin.Builder.Providers.Drip.init();